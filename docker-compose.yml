version: '3.8'

services:
  # Serveur RemoteShell
  remoteshell-server:
    build: .
    container_name: remoteshell-server
    ports:
      - "8080:8080"
    environment:
      - REMOTESHELL_SERVER_HOST=0.0.0.0
      - REMOTESHELL_SERVER_PORT=8080
      - REMOTESHELL_DB_PATH=/app/data/remoteshell.db
      - REMOTESHELL_LOG_LEVEL=info
    volumes:
      - remoteshell-data:/app/data
      - ./certs:/app/certs:ro  # Pour les certificats TLS
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Agent RemoteShell (exemple)
  remoteshell-agent:
    build: .
    container_name: remoteshell-agent
    environment:
      - REMOTESHELL_AGENT_ID=agent-docker-001
      - REMOTESHELL_AGENT_NAME=Docker Agent
      - REMOTESHELL_SERVER_HOST=remoteshell-server
      - REMOTESHELL_SERVER_PORT=8080
      - REMOTESHELL_AUTH_TOKEN=docker-agent-token
    depends_on:
      - remoteshell-server
    restart: unless-stopped
    command: ["./remoteshell-agent", "--server", "remoteshell-server:8080", "--token", "docker-agent-token", "--name", "Docker Agent"]
    # Désactiver par défaut - décommentez pour activer
    profiles:
      - agent

  # Base de données PostgreSQL (optionnel)
  postgres:
    image: postgres:15-alpine
    container_name: remoteshell-postgres
    environment:
      - POSTGRES_DB=remoteshell
      - POSTGRES_USER=remoteshell
      - POSTGRES_PASSWORD=remoteshell_password
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    profiles:
      - postgres

  # Reverse proxy Nginx (optionnel)
  nginx:
    image: nginx:alpine
    container_name: remoteshell-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
    depends_on:
      - remoteshell-server
    restart: unless-stopped
    profiles:
      - nginx

volumes:
  remoteshell-data:
    driver: local
  postgres-data:
    driver: local

networks:
  default:
    name: remoteshell-network


