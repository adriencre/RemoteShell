services:
  # Serveur RemoteShell - Configuration de production
  remoteshell-server:
    build: .
    container_name: remoteshell-server
    ports:
      - "8081:8081"
    environment:
      # Configuration serveur
      - REMOTESHELL_SERVER_HOST=0.0.0.0
      - REMOTESHELL_SERVER_PORT=8081
      - REMOTESHELL_DB_PATH=/app/data/remoteshell.db
      - REMOTESHELL_LOG_LEVEL=info
      - REMOTESHELL_AUTH_TOKEN=${REMOTESHELL_AUTH_TOKEN}
      # Configuration OAuth2 / Authentik
      - REMOTESHELL_OAUTH2_ENABLED=${REMOTESHELL_OAUTH2_ENABLED:-true}
      - REMOTESHELL_OAUTH2_PROVIDER=${REMOTESHELL_OAUTH2_PROVIDER:-authentik}
      - REMOTESHELL_OAUTH2_CLIENT_ID=${REMOTESHELL_OAUTH2_CLIENT_ID}
      - REMOTESHELL_OAUTH2_CLIENT_SECRET=${REMOTESHELL_OAUTH2_CLIENT_SECRET}
      - REMOTESHELL_OAUTH2_BASE_URL=${REMOTESHELL_OAUTH2_BASE_URL}
      - REMOTESHELL_OAUTH2_REDIRECT_URL=${REMOTESHELL_OAUTH2_REDIRECT_URL}
    volumes:
      - remoteshell-data:/app/data
      - ./certs:/app/certs:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8081/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - remoteshell-network

volumes:
  remoteshell-data:
    driver: local

networks:
  remoteshell-network:
    name: remoteshell-network

